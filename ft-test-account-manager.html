<!--
Copyright 2017 FileThis, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->


<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">

<script src="../validator-js/validator.js"></script>

<link rel="import" href="../ft-confirmation-dialog/ft-confirmation-dialog.html">
<link rel="import" href="../ft-error-behavior/ft-error-behavior.html">
<link rel="import" href="../ft-http-behavior/ft-http-behavior.html">
<link rel="import" href="../ft-labeled-icon-button/ft-labeled-icon-button.html">

<link rel="import" href="custom-validator.html">


<!--
`ft-test-account-manager`
An element that provides an easy way for an partner admin to create and delete user test accounts, and to create and
delete access tokens for the accounts. It saves settings and the current account and token in browser local storage
for convenience. Stored secrets can be cleared from storage at will.
-->

<dom-module id="ft-test-account-manager">

    <style include="iron-flex iron-flex-alignment iron-positioning"></style>

    <template>

        <style>
            :host {
                display:block;
            }
        </style>

        <style>
            .section-title
            {
                font-family:'Roboto', sans-serif;
                font-size:16pt;
                margin-top:16px;
                padding-left:20px;
                padding-right:10px;
            }
            .section-body
            {
                padding-left:20px;
                padding-right:10px;
                padding-bottom:10px;
            }
            .section-divider
            {
                width:100%;
                height:1px;
                min-height: 1px;
                clear:both;
                border-bottom:1px solid #DDD;
            }
            .field-to-buttons-space
            {
                width:30px;
            }
            .inter-button-space
            {
                width:15px;
            }
        </style>

        <div class="layout vertical"
             style="width:400px;
                    padding:0;
                    background-color:white;">

            <!-- Server -->

            <div class="section-title" hidden$="[[!showServer]]">FileThis Server</div>

            <div class="section-body layout horizontal center" hidden$="[[!showServer]]">

                <!-- Server -->
                <custom-validator id="urlValidator" validator-name="url-validator"></custom-validator>
                <paper-input
                        id="serverField"
                        value="{{server}}"
                        label="URL"
                        auto-validate
                        validator="url-validator"
                        error-message="Must be a valid URL"
                        style="width:100%;">
                </paper-input>

                <div class="field-to-buttons-space"></div>

                <!-- Default button -->
                <ft-labeled-icon-button
                        id="defaultServerButton"
                        icon="undo"
                        label="Default"
                        disabled="[[!_canDeleteUserServer]]"
                        on-click="_onDefaultServerButtonClicked">
                </ft-labeled-icon-button>

                <div class="inter-button-space"></div>

                <!-- Test Server button -->
                <ft-labeled-icon-button
                        id="testServerButton"
                        icon="check"
                        label="Test"
                        disabled="[[!_canTestServer]]"
                        on-click="_onTestServerButtonClicked">
                </ft-labeled-icon-button>
                <paper-tooltip
                        id="testServerButtonTooltip"
                        manual-mode="true"
                        for="testServerButton"
                        position="right"
                        animation-delay="0"
                        offset="5">
                    Server URL is valid and reachable
                </paper-tooltip>

            </div>

            <!-- Divider -->
            <div class="section-divider" hidden$="[[!showServer]]"></div>

            <!-- API Credentials -->

            <div class="section-title">Partner API Credentials</div>

            <custom-validator id="alphanumericValidator" validator-name="alphanumeric-validator"></custom-validator>

            <!-- API Key -->
            <div class="section-body layout horizontal center">

                <!-- API Key -->
                <paper-input
                        id="apiKeyField"
                        autofocus
                        label="API Key"
                        value="{{apiKey}}"
                        type="[[_computeInputType(_showSecrets)]]"
                        auto-validate
                        validator="alphanumeric-validator"
                        error-message="Must be an alphanumeric string"
                        char-counter
                        style="width:100%;">
                </paper-input>

                <div class="field-to-buttons-space"></div>

                <!-- Spacer, same width as "Test" button on line below -->
                <div style="width:49px; min-width:49px; height:49px; max-height:49px;"></div>

            </div>

            <!-- API Secret -->
            <div class="section-body layout horizontal center">

                <!-- API Secret -->
                <paper-input
                        id="apiSecretField"
                        autofocus
                        label="API Secret"
                        value="{{apiSecret}}"
                        type="[[_computeInputType(_showSecrets)]]"
                        auto-validate
                        validator="alphanumeric-validator"
                        error-message="Must be an alphanumeric string"
                        char-counter
                        style="width:100%;">
                </paper-input>

                <div class="field-to-buttons-space"></div>

                <!-- Test API credentials button -->
                <ft-labeled-icon-button
                        id="testApiCredentialsButton"
                        icon="check"
                        label="Test"
                        disabled="[[!_canTestApiCredentials]]"
                        on-click="_onTestApiCredentialsButtonClicked">
                </ft-labeled-icon-button>
                <paper-tooltip
                        id="testApiCredentialsButtonTooltip"
                        manual-mode="true"
                        for="testApiCredentialsButton"
                        position="right"
                        animation-delay="0"
                        offset="5">
                    The API credentials are valid.
                </paper-tooltip>

            </div>

            <!-- Divider -->
            <div class="section-divider"></div>

            <!-- User Account -->

            <div class="section-title">User Account</div>

            <div class="section-body layout horizontal center">

                <!-- User acccount id -->
                <paper-input
                        id="userAccountIdField"
                        label="Id"
                        value="{{userAccountId}}"
                        auto-validate
                        pattern="[0-9]+"
                        error-message="Not a valid FileThis acccount id"
                        style="width:100%;">
                </paper-input>

                <div class="field-to-buttons-space"></div>

                <!-- Delete Account button -->
                <ft-labeled-icon-button
                        id="deleteAccountButton"
                        icon="remove"
                        label="Delete"
                        disabled="[[!_canDeleteUserAccount]]"
                        on-click="_onDeleteAccountButtonClicked">
                </ft-labeled-icon-button>

                <div class="inter-button-space"></div>

                <!-- Create Account button -->
                <ft-labeled-icon-button
                        id="createAccountButton"
                        icon="add"
                        label="New"
                        disabled="[[!_canCreateUserAccount]]"
                        on-click="_onCreateAccountButtonClicked">
                </ft-labeled-icon-button>

                <div class="inter-button-space"></div>

                <!-- Test Account button -->
                <ft-labeled-icon-button
                        id="testAccountButton"
                        icon="check"
                        label="Test"
                        disabled="[[!_canTestUserAccount]]"
                        on-click="_onTestAccountButtonClicked">
                </ft-labeled-icon-button>
                <paper-tooltip
                        id="testAccountButtonTooltip"
                        manual-mode="true"
                        for="testAccountButton"
                        position="right"
                        animation-delay="0"
                        offset="5">
                    The user account id is valid.
                </paper-tooltip>

            </div>

            <!-- Divider -->
            <div class="section-divider"></div>

            <!-- User Access -->

            <div class="section-title">User Access Token</div>

            <div class="section-body layout horizontal center">

                <!-- token -->
                <paper-input
                        id="tokenField"
                        label="Token"
                        value="{{token}}"
                        type="[[_computeInputType(_showSecrets)]]"
                        char-counter
                        style="width:100%;">
                </paper-input>

                <div class="field-to-buttons-space"></div>

                <!-- Delete Token button -->
                <ft-labeled-icon-button
                        id="deleteTokenButton"
                        icon="remove"
                        label="Delete"
                        disabled="[[!_canDeleteToken]]"
                        on-click="_onDeleteTokenButtonClicked">
                </ft-labeled-icon-button>

                <div class="inter-button-space"></div>

                <!-- Create Token button -->
                <ft-labeled-icon-button
                        id="createTokenButton"
                        icon="add"
                        label="New"
                        disabled="[[!_canCreateToken]]"
                        on-click="_onCreateTokenButtonClicked">
                </ft-labeled-icon-button>

                <div class="inter-button-space"></div>

                <!-- Test Token button -->
                <ft-labeled-icon-button
                        id="testTokenButton"
                        icon="check"
                        label="Test"
                        disabled="[[!_canTestToken]]"
                        on-click="_onTestTokenButtonClicked">
                </ft-labeled-icon-button>
                <paper-tooltip
                        id="testTokenButtonTooltip"
                        manual-mode="true"
                        for="testTokenButton"
                        position="right"
                        animation-delay="0"
                        offset="5">
                    The token is valid.
                </paper-tooltip>

            </div>

            <!-- Divider -->
            <div class="section-divider"></div>

            <!-- Secrets -->
            <div
                    class="section-body layout horizontal center"
                    style="margin-top:16px;">

                <!-- Show Secrets checkbox -->
                <paper-checkbox
                        checked="{{_showSecrets}}">
                    Show Secrets
                </paper-checkbox>

                <div class="flex"></div>

                <!-- Clear Stored Secrets button -->
                <ft-labeled-icon-button
                        id="clearSecretsButton"
                        icon="clear"
                        label="Clear"
                        disabled="[[!_canClearSecrets]]"
                        on-click="_onClearSecretsButtonClicked">
                </ft-labeled-icon-button>
            </div>

        </div>

        <!-- Confirmation dialog -->
        <ft-confirmation-dialog id="confirmationDialog"></ft-confirmation-dialog>

    </template>

    <script>
        Polymer({

            is: 'ft-test-account-manager',

            behaviors: [FtErrorBehavior, FtHttpBehavior],

            properties: {

                /** Whether the FileThis Connect instance is enabled or not */
                enabled:
                {
                    type: Boolean,
                    notify: true,
                    value: false
                },

                /** Whether the FileThis Connect instance can be enabled or not */
                canEnable:
                {
                    type: Boolean,
                    notify: true,
                    value: false
                },

                /** The FileThis server URL. Used by FileThis for testing against non-production servers. Defaults to value of _defaultServer_ property. */
                server: {
                    type: String,
                    notify: true,
                    value: "",
                    observer: "_onSettingChanged"
                },

                /** The path under the baseUrl used for API requests. For example: "/api/v1". Note that you should use a leading slash, and no trailing slash. */
                apiPath:
                {
                    type: String,
                    value: "/api/v1",
                    observer: "_onSettingChanged"
                },

                /** The Partner API key. */
                apiKey: {
                    type: String,
                    notify: true,
                    value: "",
                    observer: "_onSettingChanged"
                },

                /** The Partner API secret. */
                apiSecret: {
                    type: String,
                    notify: true,
                    value: "",
                    observer: "_onSettingChanged"
                },

                /** The user's FileThis account id. */
                userAccountId: {
                    type: String,
                    notify: true,
                    value: "",
                    observer: "_onSettingChanged"
                },

                /** The user's FileThis user access token. Used to authenticate and authorize requests to the FileThis API endpoints. */
                tokenId: {
                    type: String,
                    notify: true,
                    value: ""
                },

                token: {
                    type: String,
                    notify: true,
                    value: "",
                    observer: "_onSettingChanged"
                },

                /** Whether to display the server URL field. Used by FileThis for testing against non-production servers. */
                showServer: {
                    type: Boolean,
                    notify: true,
                    value: true
                },

                /** The default server URL. Used by FileThis for testing against non-production servers. */
                defaultServer: {
                    type: String,
                    notify: false,
                    value: "https://filethis.com"
                },


                // Properties that enable/disable buttons ---------------------------------------------------

                _canSetDefaultServer: {
                    type: Boolean,
                    value: false
                },

                _canCreateUserAccount: {
                    type: Boolean,
                    value: false
                },

                _canDeleteUserAccount: {
                    type: Boolean,
                    value: false
                },

                _canCreateToken: {
                    type: Boolean,
                    value: false
                },

                _canDeleteToken: {
                    type: Boolean,
                    value: false
                },

                _canClearSecrets: {
                    type: Boolean,
                    value: false
                },

                _showSecrets: {
                    type: Boolean,
                    value: false
                },

                _suppressWriteToLocalStorage: {
                    type: Boolean,
                    value: true
                }
            },


            // Startup -------------------------------------------------------------------------------------

            ready: function()
            {
                this.$.urlValidator.validate = this._validateUrl.bind(this);
                this.$.alphanumericValidator.validate = this._validateAlphanumeric.bind(this);

                this.async(function()
                {
                    this._readFromLocalStorage();
                    this._enableOrDisableButtons();
                }, 200)
            },


            // Validation functions ---------------------------------------------------

            _validateUrl: function(value)
            {
                if (!value)
                    return true;
                var options =
                    {
                        protocols: ["http", "https"],
                        require_protocol: true
                    };
                return validator.isURL(value, options);
            },

            _validateAlphanumeric: function(value)
            {
                if (!value)
                    return true;
                return validator.isAlphanumeric(value);
            },


            // Updating button enable/disable properties ---------------------------------------------------

            _checkCanSetDefaultServer: function()
            {
                if (!this.server)
                    return true;
                if (this.server !== this.defaultServer)
                    return true;
                return false;
            },

            _checkCanUseServer: function()
            {
                if (!this.server)
                    return false;
                if (this.$.serverField.invalid)
                    return false;

                return true;
            },

            _checkCanUsePartnerCredentials: function()
            {
                if (!this._checkCanUseServer())
                    return false;

                if (!this.apiKey)
                    return false;
                if (this.$.apiKeyField.invalid)
                    return false;

                if (!this.apiSecret)
                    return false;
                if (this.$.apiSecretField.invalid)
                    return false;

                return true;
            },

            _checkCanUseUserAccount: function()
            {
                if (!this._checkCanUsePartnerCredentials())
                    return false;

                if (!this.userAccountId)
                    return false;
                if (this.$.userAccountIdField.invalid)
                    return false;

                return true;
            },

            _checkCanUseToken: function()
            {
                if (!this._checkCanUseUserAccount())
                    return false;

                if (!this.token)
                    return false;
                if (this.$.tokenField.invalid)
                    return false;

                return true;
            },

            _checkCanClearSecrets: function()
            {
                if (this.apiKey)
                    return true;
                if (this.apiSecret)
                    return true;
                if (this.token)
                    return true;
                if (this.userAccountId)
                    return true;
                return false;
            },

            _enableOrDisableButtons: function()
            {
                this._canSetDefaultServer = this._checkCanSetDefaultServer();
                this._canTestServer = this._checkCanUseServer();
                this._canTestApiCredentials = this._checkCanUsePartnerCredentials();
                this._canCreateUserAccount = this._checkCanUsePartnerCredentials();
                this._canDeleteUserAccount = this._checkCanUseUserAccount();
                this._canTestUserAccount = this._checkCanUseUserAccount();
                this._canCreateToken = this._checkCanUseUserAccount();
                this._canDeleteToken = this._checkCanUseToken();
                this._canTestToken = this._checkCanUseToken();
                this._canClearSecrets = this._checkCanClearSecrets();
            },

            _onSettingChanged: function(to, from)
            {
                this._writeToLocalStorage();
                this._enableOrDisableButtons();

                this.canEnable = this._checkCanEnable();
            },

            _checkCanEnable: function()
            {
                if (!this.server)
                    return false;
                if (!this.apiPath)
                    return false;
                if (!this.userAccountId)
                    return false;
                if (!this.token)
                    return false;
                return true;
            },

            _computeInputType: function(showSecrets)
            {
                if (showSecrets)
                    return "text";
                else
                    return "password";
            },


            // Local storage ----------------------------------------------------------------------------

            _readFromLocalStorage: function()
            {
                this._suppressWriteToLocalStorage = true;
                try
                {
                    var server = this._readFromLocalStorageSingle("server");
                    if (server)
                        this.server = server;
                    else
                        this.server = this.defaultServer;
                    this.apiKey = this._readFromLocalStorageSingle("apiKey");
                    this.apiSecret = this._readFromLocalStorageSingle("apiSecret");
                    this.userAccountId = this._readFromLocalStorageSingle("userAccountId");
                    this.tokenId = this._readFromLocalStorageSingle("tokenId");
                    this.token = this._readFromLocalStorageSingle("token");
                }
                finally
                {
                    this._suppressWriteToLocalStorage = false;
                }
            },

            _writeToLocalStorage: function()
            {
                if (this._suppressWriteToLocalStorage === undefined || this._suppressWriteToLocalStorage)
                    return;
                localStorage.setItem("server", this.server);
                localStorage.setItem("apiKey", this.apiKey);
                localStorage.setItem("apiSecret", this.apiSecret);
                localStorage.setItem("tokenId", this.tokenId);
                localStorage.setItem("token", this.token);
                localStorage.setItem("userAccountId", this.userAccountId);
            },

            _readFromLocalStorageSingle: function(name)
            {
                var value = localStorage.getItem(name);
                if (value == null)
                    value = "";
                return value;
            },


            // Button click handlers ----------------------------------------------------------------------------

            _onDefaultServerButtonClicked: function(event, detail)
            {
                const overrideWarning = event.metaKey;
                if (overrideWarning)
                {
                    this._restoreDefaultServer();
                    return;
                }

                const url = "https://filethis.com";
                const prompt = "Are you sure you want to restore the default of " + url + "?";
                return this.$.confirmationDialog.confirm(prompt, "Restore")
                    .then(function(choice)
                    {
                        if (choice === "cancel")
                            return;
                        this._restoreDefaultServer();
                    }.bind(this))
            },

            _restoreDefaultServer: function(event, detail)
            {
                this.server = "https://filethis.com";
            },

            _onTestServerButtonClicked: function(event, detail)
            {
                var url = this.server + this.apiPath + "/healthcheck";
                const options = this._buildHttpOptions();
                this.httpGet(url, options)
                    .then(function(response)
                    {
                        this._showTooltip(testServerButtonTooltip);
                    }.bind(this))
                    .catch(function(error)
                    {
                        this.$.confirmationDialog.alert("Cannot reach this server. Are you sure the URL is correct?")
                    }.bind(this))
            },

            _onTestApiCredentialsButtonClicked: function(event, detail)
            {
                var url = this.server + this.apiPath + "/partners";
                const options = this._buildHttpOptions();
                this.httpGet(url, options)
                    .then(function(response)
                    {
                        this._showTooltip(testApiCredentialsButtonTooltip);
                    }.bind(this))
                    .catch(function(error)
                    {
                        this._displayTestError(error);
                    }.bind(this))
            },

            _onTestAccountButtonClicked: function(event, detail)
            {
                var url = this.server + this.apiPath + "/accounts/" + this.userAccountId;
                const options = this._buildHttpOptions();
                this.httpGet(url, options)
                    .then(function(response)
                    {
                        this._showTooltip(testAccountButtonTooltip);
                    }.bind(this))
                    .catch(function(error)
                    {
                        this._displayTestError(error);
                    }.bind(this))
            },

            _onTestTokenButtonClicked: function(event, detail)
            {
                var url = this.server + this.apiPath + "/accounts/" + this.userAccountId;
                const options =  {
                    headers: {
                        "X-FileThis-Session": this.token
                    }
                };
                this.httpGet(url, options)
                    .then(function(response)
                    {
                        this._showTooltip(testTokenButtonTooltip);
                    }.bind(this))
                    .catch(function(error)
                    {
                        this._displayTestError(error);
                    }.bind(this))
            },

            _onCreateAccountButtonClicked: function(event, detail)
            {
                Promise.resolve()
                    .then(function()
                    {
                        // If there is no current user account, go ahead and create one
                        const haveCurrentAccount = !!this.userAccountId;
                        if (!haveCurrentAccount)
                            return this._createUserAccount();

                        // If caller asked to override the warning, go ahead and delete and recreate the user account
                        const overrideWarning = event.metaKey;
                        if (overrideWarning)
                            return this._deleteAndRecreateUserAccount();

                        // Ask the caller to confirm that they really want to delete the current user account
                        var prompt = "Are you sure you want to create a new user account?";
                        if (!!this.token)
                            prompt += "<br><br>The current account and access token will be deleted first, if they exist.";
                        else
                            prompt += "<br><br>The current account will be deleted first, if it exists.";
                        return this.$.confirmationDialog.confirm(prompt, "Proceed")
                            .then(function(choice)
                            {
                                if (choice === "cancel")
                                    throw "cancel";
                                return this._deleteAndRecreateUserAccount();
                            }.bind(this))
                    }.bind(this))
                    .then(function(response)
                    {
                        this.userAccountId = response.id;
                    }.bind(this))
                    .catch(function(reason)
                    {
                        if (reason === "cancel")
                            return;
                        this.handleCaughtError(reason);
                    }.bind(this));
            },
            
            _deleteAndRecreateUserAccount: function()
            {
                return this._deleteUserAccount()
                    .catch(function(reason)
                    {
                        if (reason === "cancel")
                            throw "cancel";
                    }.bind(this))
                    .then(function()
                    {
                        this.userAccountId = "";

                        // Deleting an account deletes its tokens
                        this.tokenId = "";
                        this.token = "";
                    }.bind(this))
                    .then(this._createUserAccount.bind(this));
            },

            _onDeleteAccountButtonClicked: function(event, detail)
            {
                const overrideWarning = event.metaKey;
                if (overrideWarning)
                    return this._deleteUserAccountAction();

                var prompt = "Are you sure you want to delete the user account?";
                if (!!this.token)
                    prompt += "<br><br>This will also delete the current user access token, if it exists.";
                this.$.confirmationDialog.confirm(prompt, "Delete User Account")
                    .then(function(choice)
                    {
                        if (choice === "cancel")
                            return;
                        return this._deleteUserAccountAction();
                    }.bind(this))
            },

            _deleteUserAccountAction: function()
            {
                this._deleteUserAccount()
                    .then(function()
                    {
                        this.userAccountId = "";

                        // Deleting an account deletes its tokens
                        this.tokenId = "";
                        this.token = "";
                    }.bind(this))
                    .catch(function(reason)
                    {
                        if (reason === "cancel")
                            return;
                        this.handleCaughtError(reason);
                    }.bind(this));
            },

            _onCreateTokenButtonClicked: function(event, detail)
            {
                Promise.resolve()
                    .then(function()
                    {
                        // If there is no current token, go ahead and create one
                        const haveCurrentToken = !!this.token;
                        if (!haveCurrentToken)
                            return this._createToken();

                        // If caller asked to override the warning, go ahead and delete and recreate the token
                        const overrideWarning = event.metaKey;
                        if (overrideWarning)
                            return this._deleteAndRecreateToken();

                        // Ask the caller to confirm that they really want to delete the current token
                        const prompt = "Creating a new user access token will first delete the current one, if it exists.\nDo you want do proceed?";
                        return this.$.confirmationDialog.confirm(prompt, "Proceed")
                            .then(function(choice)
                            {
                                if (choice === "cancel")
                                    throw "cancel";
                                return this._deleteAndRecreateToken();
                            }.bind(this))
                    }.bind(this))
                    .then(function(response)
                    {
                        this.tokenId = response.id;
                        this.token = response.token;
                    }.bind(this))
                    .catch(function(reason)
                    {
                        if (reason === "cancel")
                            return;
                        this.handleCaughtError(reason);
                    }.bind(this));
            },

            _deleteAndRecreateToken: function()
            {
                return this._deleteToken()
                    .catch(function(reason)
                    {
                        if (reason === "cancel")
                            throw "cancel";
                        // Ignore. Token likely timed out.
                    }.bind(this))
                    .then(function()
                    {
                        this.tokenId = "";
                        this.token = "";
                    }.bind(this))
                    .then(this._createToken.bind(this));
            },

            _onDeleteTokenButtonClicked: function(event, detail)
            {
                const overrideWarning = event.metaKey;
                if (overrideWarning)
                    return this._onDeleteTokenButtonAction();

                const prompt = "Are you sure you want to delete the user access token?";
                this.$.confirmationDialog.confirm(prompt, "Delete Token")
                    .then(function(choice)
                    {
                        if (choice === "cancel")
                            return;
                        return this._onDeleteTokenButtonAction();
                    }.bind(this))
            },

            _onDeleteTokenButtonAction: function()
            {
                this._deleteToken()
                    .then(function()
                    {
                        this.tokenId = "";
                        this.token = "";
                    }.bind(this))
                    .catch(function(reason)
                    {
                        if (reason === "cancel")
                            return;
                        this.handleCaughtError(reason);
                    }.bind(this));
            },

            _onClearSecretsButtonClicked: function(event, detail)
            {
                const overrideWarning = event.metaKey;
                if (overrideWarning)
                    return this._onClearSecretsAction();

                var prompt = "Are you sure you want to the clear secrets stored in your browser's local storage?";
                prompt += "<br><br>Secrets include the API key, API secret, and the current user access token.";
                this.$.confirmationDialog.confirm(prompt, "Clear Secrets")
                    .then(function(choice)
                    {
                        if (choice === "cancel")
                            return;
                        return this._onClearSecretsAction();
                    }.bind(this))
            },

            _onClearSecretsAction: function()
            {
                this._clearSecrets()
                    .catch(function(reason)
                    {
                        if (reason === "cancel")
                            return;
                        this.handleCaughtError(reason);
                    }.bind(this));
            },

            _clearSecrets: function()
            {
                // TODO: Prompt to delete account and token

                this._suppressWriteToLocalStorage = true;
                try
                {
                    this.apiKey = "";
                    this.apiSecret = "";
                    this.token = "";
                    this.tokenId = "";
                }
                finally
                {
                    this._suppressWriteToLocalStorage = false;
                }
                this._writeToLocalStorage();
            },


            // Actions -------------------------------------------------------------------------------------

            _deleteUserAccount: function()
            {
                const url = this.server + "/api/v1/accounts/" + this.userAccountId;
                const options = this._buildHttpOptions();
                return this.httpDelete(url, options);
            },

            _createUserAccount: function()
            {
                const url = this.server + "/api/v1/accounts/";
                const partnerAccountId = this._generateGuid();
                const body = {
                    partnerAccountId: partnerAccountId
                };
                const options = this._buildHttpOptions();
                return this.httpPost(url, body, options);
            },

            _deleteToken: function()
            {
                const url = this.server + "/api/v1/accounts/" + this.userAccountId + "/tokens/" + this.tokenId;
                const options = this._buildHttpOptions();
                return this.httpDelete(url, options);
            },

            _createToken: function()
            {
                const url = this.server + "/api/v1/accounts/" + this.userAccountId + "/tokens/";
                const body = {
                    expiresIn: 120  // Two hours
                };
                const options = this._buildHttpOptions();
                return this.httpPost(url, body, options);
            },

            _buildHttpOptions: function()
            {
                const authorizationValue = "Basic " + btoa(this.apiKey + ":" + this.apiSecret);

                return {
                    withCredentials: true,
                    headers: {
                        Authorization: authorizationValue
                    }
                };
            },

            _generateGuid: function()
            {
                function s4()
                {
                    return Math.floor((1 + Math.random()) * 0x10000)
                        .toString(16)
                        .substring(1);
                }

                return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                    s4() + '-' + s4() + s4() + s4();
            },

            _showTooltip: function(tooltip)
            {
                tooltip.show();
                setTimeout(function()
                {
                    tooltip.hide();
                }.bind(this), 2000)
            },

            _displayTestError: function(error)
            {
                // Handle certain server error responses
                if (error instanceof FtHttpUnsuccessfulError)
                {
                    const status = error.status;
                    const response = error.response;
                    const message = response.message;

                    // If the token expired, or is invalid
                    if (status === 400 &&
                        message === "User access token expired")
                    {
                        this.$.confirmationDialog.alert("User access token is expired or invalid.");
                        return;
                    }

                    // If the account could not be found
                    if (status === 404 &&
                        message.startsWith("An account with the requested id"))
                    {
                        this.$.confirmationDialog.alert("The given user account was not found.");
                        return;
                    }
                }

                // Display a dialog for other kinds of errors, like networking
                this.handleCaughtError(error);
            }

        });

    </script>
</dom-module>
